<!--
Arquivo: dashboard.html
Cole este arquivo INTEIRO, substituindo o seu dashboard.html atual.
Observa√ß√£o: N√ÉO inclui l√≥gica de gr√°ficos aqui ‚Äî isso fica em js/dashboard.js.
Este HTML s√≥ garante: estrutura, IDs corretos, tabela oculta, bot√µes (sync/pdf/tabela), √°reas dos gr√°ficos e insights.
-->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | Agenda SISREG</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="shared/css/theme.css">
  <link rel="stylesheet" href="shared/css/variables.css">
  <link rel="stylesheet" href="shared/css/base.css">
  <link rel="stylesheet" href="shared/css/style.css">

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    /* Mantive APENAS o m√≠nimo para a p√°gina n√£o ‚Äúquebrar‚Äù
       (o visual deve vir do theme.css) */
    body{ margin:0; font-family:'Inter',sans-serif; }
    #secTabela{ display:none; }
    .full-width{ grid-column: 1 / -1; }

    /* [AJUSTE] Bot√£o "Ver Tabela" dentro do card Insights */
    #cardInsights .card-head{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }
    
    /* override do .card h3 (pra n√£o dar margem duplicada) */
    #cardInsights .card-head h3{
      margin: 0;
    }
    
    #cardInsights #btnToggleTabela{
      white-space: nowrap;
    }

  </style>
</head>

<body>

  <!-- HEADER -->
  <header class="dash-header">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div class="unit-info">
        <h1 id="txtUnidade">Carregando unidade...</h1>
        <p>Painel Gerencial de Escalas ‚Ä¢ <strong>SISREG Amazonas</strong></p>
      </div>
  
      <div class="header-btns">
        <button id="btnSincronizar" class="btn-main btn-sync">üîÑ Sincronizar</button>
        <button id="btnExportarPDF" class="btn-main">üìÑ Exportar PDF</button>
        <a href="escalas.html" style="text-decoration:none;">
          <button class="btn-main btn-new">‚ûï Nova Escala</button>
        </a>
        <button id="btnLogout" class="btn-main btn-logout">Sair</button>
      </div>
    </div>
  </header>

  <!-- FILTRO (Fase 2/3 usam esse id) -->
  <section class="filter-section">
    <label for="filtroMes">Filtrar por M√™s de Vig√™ncia:</label>
    <select id="filtroMes">
      <option value="todos">Mostrar Todos</option>
      <option value="01">Janeiro</option><option value="02">Fevereiro</option><option value="03">Mar√ßo</option>
      <option value="04">Abril</option><option value="05">Maio</option><option value="06">Junho</option>
      <option value="07">Julho</option><option value="08">Agosto</option><option value="09">Setembro</option>
      <option value="10">Outubro</option><option value="11">Novembro</option><option value="12">Dezembro</option>
    </select>
  </section>

  <!-- √ÅREA DO DASHBOARD (usada no PDF) -->
  <main class="container" id="dashboardArea">

    <!-- KPIs (IDs devem bater com dashboard.js) -->
    <section class="kpi-container">
      <div class="kpi-card">
        <h3>Total de Vagas</h3>
        <p id="kpiVagas">0</p>
      </div>

      <div class="kpi-card">
        <h3>% Vagas Retorno</h3>
        <p id="kpiRetorno">0%</p>
      </div>

      <div class="kpi-card">
        <h3>Profissionais</h3>
        <p id="kpiProfissionais">0</p>
      </div>

      <div class="kpi-card">
        <h3>Procs. √önicos</h3>
        <p id="kpiProcedimentos">0</p>
      </div>

      <div class="kpi-card">
        <h3>Procedimento L√≠der</h3>
        <p id="kpiLider" style="font-size:1rem;">-</p>
      </div>
    </section>

    <!-- GRID DE GR√ÅFICOS -->
    <section class="dashboard-grid">

      <div class="card">
        <h3>üî• Oferta por Dia e Hor√°rio</h3>
        <canvas id="chartHeatmap"></canvas>
      </div>

      <div class="card">
        <h3>üéØ Funil de Oferta</h3>
        <canvas id="chartFunil"></canvas>
      </div>

      <div class="card">
        <h3>üß¨ Perfil da Unidade</h3>
        <canvas id="chartRadar"></canvas>
      </div>

      <div class="card">
        <h3>ü´ß Profissionais por Impacto</h3>
        <canvas id="chartBolhas"></canvas>
      </div>

      <div class="card">
        <h3>üü° Distribui√ß√£o de Vagas</h3>
        <canvas id="chartDonut"></canvas>
      </div>

      <div class="card">
        <h3>üìà Evolu√ß√£o da Vig√™ncia</h3>
        <canvas id="chartLinha"></canvas>
      </div>

      <div class="card full-width" id="cardInsights">
        <div class="card-head">
          <h3>üß† Insights Autom√°ticos</h3>
          <button class="btn btn-toggle" id="btnToggleTabela">üìã Ver Tabela</button>
        </div>
        <ul id="listaInsights"></ul>
      </div>


      <!-- (Opcional) se seu JS da Fase 3 usar KPI de m√©dia, mantenha este id (n√£o quebra se n√£o usar) -->
      <span id="kpiMedia" style="display:none;"></span>

    </section>

    <!-- TABELA (OCULTA) ‚Äî IDs precisam bater com dashboard.js -->
    <section id="secTabela" class="card full-width" style="margin-top:20px;">
      <h3>üìã Tabela Detalhada</h3>
      <div style="overflow:auto;">
        <table id="tabEscalas">
          <thead>
            <tr>
              <th>CPF</th>
              <th>Profissional</th>
              <th>C√≥d. Proc.</th>
              <th>Procedimento</th>
              <th>Exames</th>
              <th>Dias</th>
              <th>In√≠cio</th>
              <th>Fim</th>
              <th>Vagas</th>
              <th>Vig. In√≠cio</th>
              <th>Vig. Fim</th>
            </tr>
          </thead>
          <tbody id="corpoTabela"></tbody>
        </table>
      </div>
    </section>

  </main>

  <!-- FOOTER (dashboard.js preenche esse id) -->
 <footer id="footerCreditos" class="app-footer"></footer>
  
  <!-- Seu JS principal -->
  <script src="config/config.js"></script>
  <script src="shared/components/header.js"></script>
  <script src="js/dashboard.js"></script>

  <!-- Somente eventos ‚Äúde tela‚Äù (n√£o mexe na l√≥gica do dashboard.js) -->
  <script>
    // Toggle da tabela
    document.getElementById("btnToggleTabela").onclick = () => {
      const sec = document.getElementById("secTabela");
      const aberto = sec.style.display === "block";
      sec.style.display = aberto ? "none" : "block";
      document.getElementById("btnToggleTabela").textContent = aberto ? "üìã Ver Tabela" : "üìã Ocultar Tabela";
    };

    // Exportar PDF do dashboardArea
    document.getElementById("btnExportarPDF").onclick = async () => {
      const area = document.getElementById("dashboardArea");

      // melhora captura: espera 1 frame
      await new Promise(r => requestAnimationFrame(r));

      const canvas = await html2canvas(area, { scale: 2, useCORS: true });
      const img = canvas.toDataURL("image/png");

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");

      const pageW = 210;
      const pageH = 297;

      const imgW = pageW;
      const imgH = (canvas.height * imgW) / canvas.width;

      let y = 10;
      if (imgH <= pageH - 20) {
        pdf.addImage(img, "PNG", 0, y, imgW, imgH);
      } else {
        // Pagina√ß√£o simples se ficar maior que A4
        let remaining = imgH;
        let position = 10;
        pdf.addImage(img, "PNG", 0, position, imgW, imgH);
        remaining -= (pageH - 20);

        while (remaining > 0) {
          pdf.addPage();
          position = 10 - (imgH - remaining);
          pdf.addImage(img, "PNG", 0, position, imgW, imgH);
          remaining -= (pageH - 20);
        }
      }

      const unidade = (document.getElementById("txtUnidade").textContent || "UNIDADE").trim();
      pdf.save(`Dashboard_${unidade}.pdf`);
    };
  </script>

</body>
</html>
